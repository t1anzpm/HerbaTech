<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Greenhouse Future</title>
  <meta name="theme-color" content="#052e16" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self';">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0e1b12;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --brand:#22c55e;
      --focus:#86efac;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --border:#1f2937;
      --border-2:#2b3a2f;
      --border-3:#3b4f42;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:500 16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    header{
      display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;
      padding:16px 20px;border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(34,197,94,.10), transparent);
    }
    header h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
    .grid{display:grid;gap:14px;padding:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{
      background:var(--card);
      border:1px solid var(--border-2);
      border-radius:12px;padding:14px;min-height:92px;
      box-shadow:0 1px 0 rgba(34,197,94,.08) inset;
    }
    .k{font-size:13px;color:var(--muted)}
    .v{font-size:28px;font-weight:800;letter-spacing:.2px}
    .row{display:flex;justify-content:space-between;align-items:flex-end;gap:8px}
    .unit{font-size:14px;color:var(--muted);margin-left:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;line-height:1.8;border:1px solid transparent}
    .ok{color:var(--ok);   background:rgba(22,163,74,.16);  border-color:rgba(22,163,74,.28)}
    .warn{color:var(--warn); background:rgba(245,158,11,.16); border-color:rgba(245,158,11,.28)}
    .bad{color:var(--bad);  background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.28)}
    .muted{color:var(--muted); background:rgba(148,163,184,.12); border-color:rgba(148,163,184,.20)}
    .switch{--w:44px;--h:26px;position:relative;display:inline-block;width:var(--w);height:var(--h)}
    .switch input{opacity:0;position:absolute;inset:0;margin:0}
    .slider{position:absolute;inset:0;background:#1f2937;border-radius:999px;transition:transform .2s, background .2s, box-shadow .2s}
    .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform .2s}
    input:checked + .slider{background:var(--brand); box-shadow:0 0 0 2px rgba(34,197,94,.25)}
    input:checked + .slider:before{transform:translateX(18px)}
    input:focus-visible + .slider{outline:3px solid var(--focus);outline-offset:2px}
    footer{padding:10px 16px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:10px;max-height:300px;overflow:auto}
    button{
      background:#0f1a13;border:1px solid var(--border-2);color:var(--ink);
      padding:8px 12px;border-radius:10px;cursor:pointer
    }
    button:hover{border-color:var(--border-3)}
    button:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .hidden{display:none}
    .banner{padding:8px 12px;border:1px dashed var(--border-2);border-radius:10px;margin:0 16px;color:var(--muted);font-size:13px;background:rgba(34,197,94,.04)}
    .banner.error{border-color:var(--bad);color:#fecaca;background:rgba(239,68,68,.06)}
    .banner.warn{border-color:var(--warn);color:#fed7aa;background:rgba(245,158,11,.06)}
    .debug-toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-bottom:8px}
    #lightSpark {
      width: 100%;
      height: 46px;
      margin-top: 8px;
      background: rgba(0,0,0,0.06);
      border-radius: 6px;
    }
  </style>
</head>
<body>
<header>
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h10"/>
  </svg>
  <h1>Greenhouse Future</h1>
  <span id="ts" class="muted" aria-live="polite">· cargando…</span>
</header>

<div id="netBanner" class="banner warn hidden" role="status" aria-live="polite">Sin conexión a Internet. Intentando reconectar…</div>
<div id="errBanner" class="banner error hidden" role="alert">Error obteniendo métricas. Se reintentará automáticamente.</div>

<section class="grid">
  <div class="card" aria-labelledby="k-temp">
    <div id="k-temp" class="k">Temperatura aire</div>
    <div class="row">
      <div><span id="t" class="v" aria-live="polite">–</span><span class="unit">°C</span></div>
      <span id="tBadge" class="badge muted" aria-live="polite">sin dato</span>
    </div>
  </div>

  <div class="card" aria-labelledby="k-rh">
    <div id="k-rh" class="k">Humedad relativa</div>
    <div class="row">
      <div><span id="rh" class="v" aria-live="polite">–</span><span class="unit">%</span></div>
      <span id="rhBadge" class="badge muted" aria-live="polite">sin dato</span>
    </div>
  </div>

  <div class="card" aria-labelledby="k-soil">
    <div id="k-soil" class="k">Humedad suelo</div>
    <div class="row">
      <div><span id="soil" class="v" aria-live="polite">–</span><span class="unit">%</span></div>
      <span id="soilBadge" class="badge muted" aria-live="polite">sin dato</span>
    </div>
  </div>

  <div class="card" aria-labelledby="k-ph">
    <div id="k-ph" class="k">Nivel agua de riego</div>
    <div class="row">
      <div><span id="ph" class="v" aria-live="polite">–</span></div>
      <span id="phBadge" class="badge muted" aria-live="polite">sin dato</span>
    </div>
  </div>
<!-- TARJETA: LUZ -->
<div class="card" aria-labelledby="k-light">
  <div id="k-light" class="k">Luz</div>
  <div class="row">
    <!-- valor de luz -->
    <div style="display:flex; align-items:flex-end; gap:4px;">
      <span id="envLight" class="v" aria-live="polite">–</span>
      <span class="unit">%</span>
    </div>
    <!-- switch -->
    <label class="switch" aria-label="Interruptor de luz">
      <input id="light" type="checkbox" role="switch" aria-checked="false" />
      <span class="slider" aria-hidden="true"></span>
    </label>
  </div>
  <span id="envLightBadge" class="badge muted" aria-live="polite">sin dato</span>
  <canvas id="lightSpark" width="260" height="46" aria-label="Histórico de luz"></canvas>
</div>

  <div class="card" aria-labelledby="k-conn">
    <div id="k-conn" class="k">Conexión</div>
    <div>RSSI: <b id="rssi">–</b> dBm</div>
    <div>IP: <b id="ip">–</b></div>
    <div>Edad del dato: <b id="age">–</b></div>
    <div style="margin-top:10px"><button id="refresh" type="button">Actualizar ahora</button></div>
  </div>

  <div class="card" style="grid-column:1/-1" aria-labelledby="k-debug">
    <div class="row" style="align-items:center">
      <div id="k-debug" class="k">Debug JSON</div>
    </div>
    <div class="debug-toolbar">
      <button id="copyJson" type="button" aria-label="Copiar JSON">Copiar JSON</button>
    </div>
    <pre id="raw" aria-live="polite">cargando…</pre>
  </div>
</section>

<footer>
  <span>Greenhouse Future</span>
  <span id="clock" aria-live="polite"></span>
</footer>
<script>
  const API_BASE = '';
  const $ = id => document.getElementById(id);

  const lightHistory = [];
  const LIGHT_MAX_POINTS = 30;

  async function fetchMetrics(manual = false) {
    try {
      const res = await fetch(API_BASE + '/api/metrics', { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      // mostrar json
      $('raw').textContent = JSON.stringify(data, null, 2);
      $('errBanner').classList.add('hidden');

      // timestamp
      const now = new Date();
      $('ts').textContent = '· última actualización ' + now.toLocaleTimeString();

      // ===== aire =====
      if (data.air && data.air.status === 'ok') {
        $('t').textContent  = data.air.temp_c.toFixed(1);
        $('tBadge').textContent = 'óptimo';
        $('tBadge').className = 'badge ok';

        $('rh').textContent = data.air.rh_pct.toFixed(0);
        $('rhBadge').textContent = 'óptimo';
        $('rhBadge').className = 'badge ok';
      } else {
        $('t').textContent  = '–';
        $('tBadge').textContent = 'sin dato';
        $('tBadge').className = 'badge muted';
        $('rh').textContent = '–';
        $('rhBadge').textContent = 'sin dato';
        $('rhBadge').className = 'badge muted';
      }

      // ===== suelo =====
      if (data.soil && data.soil.status === 'ok') {
        $('soil').textContent = data.soil.moisture_pct.toFixed(0);
        $('soilBadge').textContent = 'ok';
        $('soilBadge').className = 'badge ok';
      } else {
        $('soil').textContent = '–';
        $('soilBadge').textContent = 'sensor no conectado';
        $('soilBadge').className = 'badge muted';
      }

      // ===== agua =====
if (data.water && data.water.status === 'ok') {
  $('ph').textContent = data.water.ph.toFixed(2);
  $('phBadge').textContent = 'ok';
  $('phBadge').className = 'badge ok';
} else {
  $('ph').textContent = '–';
  $('phBadge').textContent = 'sensor no conectado';
  $('phBadge').className = 'badge muted';
}

// ===== luz artificial (switch) =====
if (data.light && typeof data.light.commanded_on !== 'undefined') {
  const commanded = !!data.light.commanded_on;
  $('light').checked = commanded;

  // muestra estado en el badge según la luz artificial
  if (commanded) {
    $('envLightBadge').textContent = 'encendida';
    $('envLightBadge').className = 'badge warn';
  } else {
    $('envLightBadge').textContent = 'apagada';
    $('envLightBadge').className = 'badge muted';
  }
} else {
  // si el backend no entrega data.light
  $('light').checked = false;
  $('envLightBadge').textContent = 'sin dato';
  $('envLightBadge').className = 'badge muted';
}

// ===== luz ambiental =====
if (data.env_light && data.env_light.status === 'ok') {
  const pct = Math.round(data.env_light.percent ?? 0);
  $('envLight').textContent = pct;

  // solo sobrescribimos a "óptimo" si la luz artificial está apagada
  if (!$('light').checked) {
    $('envLightBadge').textContent = 'óptimo';
    $('envLightBadge').className = 'badge ok';
  }

  // histórico del porcentaje de luz
  lightHistory.push(pct);
  if (lightHistory.length > LIGHT_MAX_POINTS) lightHistory.shift();
  drawLightSpark();
} else {
  $('envLight').textContent = '–';
  $('envLightBadge').textContent = 'sin dato';
  $('envLightBadge').className = 'badge muted';
}



      // ===== conexión =====
      if (typeof data.rssi !== 'undefined') {
        $('rssi').textContent = data.rssi;
      }
      $('ip').textContent = location.host;

    } catch (err) {
      console.warn(err);
      $('errBanner').classList.remove('hidden');
    }
  }

  function drawLightSpark() {
    const canvas = $('lightSpark');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if (lightHistory.length === 0) return;

    const max = 100;
    const step = w / Math.max(lightHistory.length - 1, 1);

    ctx.fillStyle = 'rgba(34,197,94,0.06)';
    ctx.fillRect(0,0,w,h);

    ctx.strokeStyle = '#22c55e';
    ctx.lineWidth = 2;
    ctx.beginPath();
    lightHistory.forEach((val, idx) => {
      const x = idx * step;
      const y = h - (val / max) * (h - 6) - 3;
      if (idx === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    const lastX = (lightHistory.length - 1) * step;
    const lastY = h - (lightHistory[lightHistory.length - 1] / max) * (h - 6) - 3;
    ctx.fillStyle = '#22c55e';
    ctx.beginPath();
    ctx.arc(lastX, lastY, 3, 0, Math.PI*2);
    ctx.fill();
  }

  // POST para encender/apagar
  $('light').addEventListener('change', async (ev) => {
    const desired = ev.target.checked;
    try {
      await fetch('/api/light', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ on: desired })
      });
    } catch(e) {
      console.warn(e);
    }
  });

  $('refresh').addEventListener('click', () => fetchMetrics(true));
  $('copyJson').addEventListener('click', () => {
    navigator.clipboard.writeText($('raw').textContent).catch(()=>{});
  });

  // reloj
  setInterval(() => {
    const now = new Date();
    $('clock').textContent = now.toLocaleString('es-CL');
  }, 1000);

  fetchMetrics();
  setInterval(fetchMetrics, 5000);
</script>

</body>
</html>
